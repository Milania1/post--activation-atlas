
<div bind:clientWidth style="height: {height}px;">
  <canvas ref:canvas width={gridSize} height={gridSize} style="width: {clientWidth}px; height: {height}px;"></canvas>
</div>

<script>
import { load } from 'lucid-components';
import classesToKeep from './classesToKeep.js';

export default {
  data() {
    return {
      root: "https://storage.googleapis.com/activation-atlas/build",
      model: "inceptionv1",
      layerName: "mixed4d",
      grid: 1,
      layout: 0,
      gridSize: 10,
      classHeatmap: -1,
      icons: []
    };
  },
  computed: {
    height: ({clientWidth}) => clientWidth,
    id: ({model, layerName}) => model + "_" + layerName
  },
  oncreate() {
    const {root, id, grid} = this.get();
    load(`${root}/${id}/${id}.json`).then(config => {
      // console.log("config: ", config)
      if (config.class_filter == null) { config.class_filter = "None" }
      if (config.filter == null) { config.filter = "None" }
      if (!Array.isArray(config.layout)) {config.layout = [config.layout]}
      if (!Array.isArray(config.layer)) {config.layer = [config.layer]}
      if (!Array.isArray(config.filter)) {config.filter = [config.filter]}
      this.set({gridSize: config.grid_size[grid]})
      const url = `${root}/${id}/web/web--grid_size=${config.grid_size[grid]}--layout=${config.layout[0]}--class_filter=${config.class_filter}--filter=${config.filter[0]}--layer=${config.layer[0]}--model=${config.model}--sample_images=${config.sample_images}--sample_type=${config.sample_type}.json`
      // console.log("config", config)
      load(url).then(web => {
        // console.log("web", web)
        this.set({icons: web});
        this.render();
      })
    })
  },
  onupdate({changed}) {
    if (changed.classHeatmap) {
      this.render();
    }
  },
  methods: {
    render() {
      const {gridSize, icons, classHeatmap} = this.get();
      const context = this.refs.canvas.getContext('2d');
      let imageData = context.getImageData(0, 0, gridSize, gridSize);
      let data = imageData.data;
      // for (var i = 0; i < data.length; i += 4) {
        // data[i] = 100;
        // data[i + 1] = 100;
        // data[i + 2] = 100;
        // data[i + 3] = 255;
      // }
      for (const icon of icons) {
        let heatmapMultiplier = 0.5;
        if (classHeatmap > -1) {
          let ci = classesToKeep.indexOf(classHeatmap);
          let value = Math.max(0, icon.f[ci]);
          heatmapMultiplier = Math.max(0.05, value * 5 * 4);
          // console.log(ci, value)
        }
        const y = icon.x; //x,y switched on purpose 
        const x = icon.y; //x,y switched on purpose
        // data[y * gridSize * 4 + x * 4 + 0] = (heatmapMultiplier) * 255 * 20;
        // data[y * gridSize * 4 + x * 4 + 1] = (heatmapMultiplier) * 130 * 20;
        // data[y * gridSize * 4 + x * 4 + 2] = (heatmapMultiplier) * 1 * 20;
        data[y * gridSize * 4 + x * 4 + 3] = icon.n * heatmapMultiplier;
      }
      
      context.putImageData(imageData, 0, 0);
    }
  }
}


</script>
<style>
canvas {
  image-rendering: pixelated;
}
</style>