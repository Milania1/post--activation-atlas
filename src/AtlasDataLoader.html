<script>
import { default as load } from './library/load.js';
import classesToKeep from './classesToKeep.js';

export default {
  data() {
    return {
      fingerprint: Math.random() + Date.now(),
    // root: "assets",
      root: "https://storage.googleapis.com/activation-atlas/build",
      id: "inceptionv1",
      layer: 0,
      classFilter: 0,
      filter: 0,
      layout: 0,
      config: null,
      layers: null,
      labels: null
    };
  },
  onupdate({ changed, current, previous }) {
    this.set({data: null});
    if (changed.layer || changed.classFilter || changed.id || changed.layout || changed.filter) {

      const {root, id, layer, classFilter, filter, fingerprint, layout} = this.get();

      load(`${root}/${id}/${id}.json`, fingerprint).then(response => {
        let config = response;
        this.set({config});

        if (classFilter !== null) {
    
          if (config.class_filter == null) { config.class_filter = "None" }
          if (config.filter == null) { config.filter = "None" }
          if (!Array.isArray(config.grid_size)) { config.grid_size = [config.grid_size] }
          if (!Array.isArray(config.class_filter)) { config.class_filter = [config.class_filter] }
          if (!Array.isArray(config.layer)) { config.layer = [config.layer] }
          if (!Array.isArray(config.layout)) { config.layout = [config.layout] }
          if (!Array.isArray(config.filter)) { config.filter = [config.filter] }
          // console.log(config.layout, layout, Array.isArray(config.layout))
          //https://storage.googleapis.com/activation-atlas/build/class_filter_inceptionv1/web/web--grid_size=8--layout=5_0.1_cosine,10_0.1_cosine,15_0.1_cosine--class_filter=7--filter=None--layer=mixed4a--model=InceptionV1--sample_images=1000000--sample_type=random.json
          //https://storage.googleapis.com/activation-atlas/build/class_filter_inceptionv1/web/web--grid_size%3D16--layout%3D10_0.1_cosine--class_filter%3D1--filter%3DNone--layer%3Dmixed4a--model%3DInceptionV1--sample_images%3D1000000--sample_type%3Drandom.json
          // console.log(config)
          let gridUrls = config.grid_size.map(g => `${root}/${id}/web/web--grid_size=${g}--layout=${config.layout[layout]}--class_filter=${config.class_filter[classFilter]}--filter=${config.filter[filter]}--layer=${config.layer[layer]}--model=${config.model}--sample_images=${config.sample_images}--sample_type=${config.sample_type}.json`)
          // console.log(gridUrls)
          load(gridUrls).then(responses => {
            let layers = Array(responses.length)
            responses.forEach((g, i) => {
              let gridSize = config.grid_size[i];
              let tileSize = config.tile_size;
              let numRows = gridSize / tileSize;
              let t = [...Array(numRows).keys()]
              // let tiles = t.map(x => Array(numRows))
              // for (let x = 0; x < numRows; x++) {
              //   for (let y = 0; y < numRows; y++) {
              //     tiles[x][y] = {
              //       //render/render--x%3D0--y%3D0--tries%3D4--alpha%3DFalse--tile_size%3D10--whiten%3Dtrue--steps%3D1024--icon_size%3D80--grid_size%3D10--layout%3D50_0.05_cosine--class_filter%3DNone--filter%3DNone--layer%3Dmixed4d--model%3DInceptionV1--sample_images%3D1000000--sample_type%3Drandom.jpg?_ga=2.191103914.-1445069976.1518735995
              //       //assets/alexnet/render/render--x=0--y=0--tries={config.tries}--tile_size={config.tile_size}--whiten={config.whiten}--steps={config.steps}--icon_size=80--grid_size=16--layout={config.layout}--class_filter=${config.class_filter[classFilter]}--filter=None--layer={layer}--model={config.model}--sample_images={config.sample_images}--sample_type={config.sample_type}.jpg
              //       url: `${root}/${id}/render/render--x=${x}--y=${y}--tries=${config.tries}--alpha=${config.alpha ? "True" : "False"}--tile_size=${config.tile_size}--whiten=${config.whiten}--steps=${config.steps}--icon_size=${config.icon_size}--grid_size=${gridSize}--layout=${config.layout}--class_filter=${config.class_filter[classFilter]}--filter=None--layer=${config.layer[layer]}--model=${config.model}--sample_images=${config.sample_images}--sample_type=${config.sample_type}.jpg`
              //     }
              //   }
              // }
              let ic = [...Array(gridSize).keys()]
              let icons = ic.map(x => Array(gridSize))
              for (const gd of g) {
                if (gd.x !== undefined) { gd.grid_x = gd.x }
                if (gd.y !== undefined) { gd.grid_y = gd.y }
                if (gd.n !== undefined) { gd.num_activations = gd.n }
                if (gd.i !== undefined) { gd.top_class_indices = gd.i }
                if (gd.v !== undefined) { gd.top_class_values = gd.v }
                if (gd.f !== undefined) { 
                  gd.full_class_values = gd.f 
                  gd.full_class_indices = classesToKeep
                }
                
                let x = gd.grid_x;
                let y = gd.grid_y;
                gd.gx = x / gridSize;
                gd.gy = y / gridSize;
                gd.gw = 1 / gridSize;
                let tileX = Math.floor(x / tileSize);
                let tileY = Math.floor(y / tileSize);
                gd.localX = x % tileSize;
                gd.localY = y % tileSize;
                          //activation-atlas/o/build%2Finceptionv1_mixed4d%2Frender%2Frender--x=0--y=0--tries=4--alpha=False--tile_size=10--whiten=true--steps=1024--icon_size=80--grid_size=10--layout=50_0.05_cosine--class_filter=None--filter=None--layer=mixed4d--model=InceptionV1--sample_images=1000000--sample_type=random.jpg
                gd.url = `${root}/${id}/render/render--x=${tileX}--y=${tileY}--tries=${config.tries}--alpha=${config.alpha ? "True" : "False"}--tile_size=${config.tile_size}--whiten=${config.whiten}--steps=${config.steps}--icon_size=${config.icon_size}--grid_size=${gridSize}--layout=${config.layout[layout]}--class_filter=${config.class_filter[classFilter]}--filter=${config.filter[filter]}--layer=${config.layer[layer]}--model=${config.model}--sample_images=${config.sample_images}--sample_type=${config.sample_type}.jpg`
                icons[gd.grid_x][gd.grid_y] = gd
              }
              layers[i] = icons
            })
            this.set({layers});
            load(`${root}/labels--model-${config.model}.txt`).then(response => {
              const labels = response.split("\n")
              this.set({labels})
            })
          })
        }
      });
    }     
  }
}
</script>